trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: SedstartVariables  # Your group with API_KEY, PROJECT_ID, TEST_ID, PROFILE_ID

# Defaults for optional vars (add to your group if you want custom)
- name: SEDSTART_BROWSER
  value: chrome
- name: SEDSTART_HEADLESS
  value: true
- name: SEDSTART_ENVIRONMENT
  value: QA

steps:
- checkout: self

# Step 1: Install Node.js 20
- task: NodeTool@0
  inputs:
    versionSpec: '20.x'
  displayName: 'Install Node.js 20'

# Step 2: Auth GitHub + Install Sedstart Runner (This fixes the permission error)
- script: |
    echo "Authenticating with GitHub for private repo..."
    # Inject PAT into git URLs for HTTPS access
    git config --global url."https://${GITHUB_PAT}@github.com/".insteadOf "https://github.com/"
    
    echo "Cleaning npm cache..."
    npm cache clean --force
    
    echo "Installing Sedstart runner from GitHub..."
    npm install -g git+https://github.com/sedinqa/sedstart-ci-run.git
    
    # Verify install
    sedstart-ci-run --version || echo "Runner installed but version check optional"
  displayName: 'Install Sedstart Runner (With GitHub Auth)'
  env:
    GITHUB_PAT: $(GITHUB_PAT)  # Your new secret

# Step 3: Run Sedstart Tests with Official Runner
- script: |
    echo "Running Sedstart test case..."
    sedstart-ci-run \
      --api_key "$(SEDSTART_API_KEY)" \
      --project_id "$(SEDSTART_PROJECT_ID)" \
      --test_id "$(SEDSTART_TEST_ID)" \
      --profile_id "$(SEDSTART_PROFILE_ID)" \
      --browser "$(SEDSTART_BROWSER)" \
      --headless "$(SEDSTART_HEADLESS)" \
      --environment "$(SEDSTART_ENVIRONMENT)"
    
    echo "Sedstart run completeâ€”check logs above for results!"
  displayName: 'Run Sedstart Test Case'
  env:
    SEDSTART_API_KEY: $(SEDSTART_API_KEY)  # Passes all secrets/vars to runner



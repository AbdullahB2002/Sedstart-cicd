trigger:
  - main
  - develop

pool:
  vmImage: 'ubuntu-latest'

steps:
  - task: PowerShell@2
    inputs:
      targetType: 'inline'
      script: |
        Write-Host "Triggering Sedstart Test Run..."

        $headers = @{
          "Authorization" = "Bearer $(SEDSTART_API_KEY)"
          "Content-Type"  = "application/json"
        }

        $body = @{
          projectId   = "$(SEDSTART_PROJECT_ID)"
          testId      = "$(SEDSTART_TEST_ID)"
          profileId   = "$(SEDSTART_PROFILE_ID)"
          browser     = "chrome"
          headless    = $true
          environment = "Prod"
        } | ConvertTo-Json

        # Trigger the test run
        $response = Invoke-RestMethod `
          -Uri "https://api.sedstart.com/api/v1/ci/run" `
          -Method Post `
          -Headers $headers `
          -Body $body

        Write-Host "Test run started! Run ID: $($response.runId) | View: https://app.sedstart.com/project/$($response.projectId)/runs/$($response.runId)"

        # Wait for completion (max 10 minutes)
        $runId = $response.runId
        $timeout = 600
        $interval = 20
        $elapsed = 0

        do {
          Start-Sleep -Seconds $interval
          $elapsed += $interval
          $status = Invoke-RestMethod -Uri "https://api.sedstart.com/api/v1/ci/run/$runId" -Headers $headers
          Write-Host "Status: $($status.status) | Passed: $($status.passedTests) | Failed: $($status.failedTests)"
          
          if ($status.status -in "completed","failed","timeout") { break }
        } while ($elapsed -lt $timeout)

        if ($status.status -ne "completed" -or $status.failedTests -gt 0) {
          Write-Error "Sedstart tests FAILED!"
          exit 1
        }

        Write-Host "Sedstart tests PASSED!"
    displayName: 'Run Sedstart Tests (Direct API)'
    env:
      SEDSTART_API_KEY: $(SEDSTART_API_KEY)

trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: SedstartVariables
- name: SEDSTART_BROWSER
  value: chrome
- name: SEDSTART_HEADLESS
  value: true
- name: SEDSTART_ENVIRONMENT
  value: QA

steps:
- checkout: self

- task: NodeTool@0
  inputs:
    versionSpec: '20.x'
  displayName: 'Install Node.js 20'

- script: |
    echo "=== VALUES WE ARE SENDING TO SEDSTART ==="
    echo "API_KEY      : ${SEDSTART_API_KEY:0:10}****************"
    echo "PROJECT_ID   : $(SEDSTART_PROJECT_ID)"
    echo "TEST_ID      : $(SEDSTART_TEST_ID)"
    echo "PROFILE_ID   : $(SEDSTART_PROFILE_ID)"
    echo "BROWSER      : $(SEDSTART_BROWSER)"
    echo "ENVIRONMENT  : $(SEDSTART_ENVIRONMENT)"
    echo ""

    echo "Calling Sedstart API..."
    curl -s -X POST https://api.sedstart.io/v1/runs \
      -H "Authorization: Bearer $(SEDSTART_API_KEY)" \
      -H "Content-Type: application/json" \
      -d '{
        "project_id":   "$(SEDSTART_PROJECT_ID)",
        "test_id":      "$(SEDSTART_TEST_ID)",
        "profile_id":   "$(SEDSTART_PROFILE_ID)",
        "browser":      "$(SEDSTART_BROWSER)",
        "headless":     $(SEDSTART_HEADLESS),
        "environment":  "$(SEDSTART_ENVIRONMENT)",
        "wait_for_completion": true
      }' -w "\nHTTP_STATUS:%{http_code}\n" > sedstart_response.txt

    cat sedstart_response.txt
    echo ""

    # Separate body and HTTP status
    HTTP_CODE=$(grep "HTTP_STATUS" sedstart_response.txt | cut -d: -f2)
    BODY=$(sed '/HTTP_STATUS/d' sedstart_response.txt)

    echo "HTTP Status Code : $HTTP_CODE"
    echo "Raw body         :"
    echo "$BODY"

    # If not 200 → fail immediately
    if [ "$HTTP_CODE" != "200" ]; then
      echo "##vso[task.logissue type=error]Sedstart API returned $HTTP_CODE"
      exit 1
    fi

    # If body is empty or not JSON → fail with clear message
    echo "$BODY" | jq . > /dev/null 2>&1
    # test if valid JSON
    if [ $? -ne 0 ]; then
      echo "##vso[task.logissue type=error]Sedstart did not return valid JSON (probably wrong API key or IDs)"
      echo "$BODY"
      exit 1
    fi

    # Extract values safely (default to 0 if missing)
    PASSED=$(echo "$BODY" | jq -r '.summary.passed // 0')
    FAILED=$(echo "$BODY" | jq -r '.summary.failed // 0')
    STATUS=$(echo "$BODY" | jq -r '.status // "failed"')

    echo "Result → Status: $STATUS | Passed: $PASSED | Failed: $FAILED"

    if [ "$FAILED" -gt 0 ]; then
      echo "##vso[task.logissue type=error]Sedstart tests FAILED ($FAILED failed)"
      exit 1
    else
      echo "All Sedstart no-code tests PASSED"
    fi
  displayName: 'Run Sedstart Tests – Final Bulletproof Version'



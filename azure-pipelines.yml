trigger:
  - main
  - develop

pool:
  vmImage: 'ubuntu-latest'  # Or 'windows-latest'

# Uncomment ONLY if your variable group is named EXACTLY "Sedstart-Vars" and exists
# variables:
#   - group: Sedstart-Vars

# Inline variables (optional overrides; use pipeline vars for secrets)
variables:
  browser: 'chrome'
  headless: 'true'
  environment: 'Prod'

steps:
  # Step 1: Install Node.js 20 (fixes npx/bash errors)
  - task: NodeTool@0
    inputs:
      versionSpec: '20.x'
    displayName: 'Install Node.js 20'

  # Step 2: Debug - Check if variables are loaded (remove after testing)
  - script: |
      echo "Debug: Project ID length = ${#SEDSTART_PROJECT_ID}"
      echo "Debug: Node version = $(node --version)"
      echo "Debug: npx available? = $(which npx)"
    displayName: 'Debug Variables & Tools'
    # env:  # If vars not loading, add: SEDSTART_PROJECT_ID: $(SEDSTART_PROJECT_ID)

  # Step 3: Run Sedstart via npx (main step)
  - script: |
      echo "Starting Sedstart test run..."
      npx @sedstart/action-run-ci@latest \
        --api-key "$(SEDSTART_API_KEY)" \
        --project-id "$(SEDSTART_PROJECT_ID)" \
        --test-id "$(SEDSTART_TEST_ID)" \
        --profile-id "$(SEDSTART_PROFILE_ID)" \
        --browser $(browser) \
        --headless $(headless) \
        --environment $(environment)
    displayName: 'Run Sedstart No-Code Tests'
    env:
      SEDSTART_API_KEY: $(SEDSTART_API_KEY)  # Ensures secret passes to bash
      SEDSTART_PROJECT_ID: $(SEDSTART_PROJECT_ID)
      SEDSTART_TEST_ID: $(SEDSTART_TEST_ID)
      SEDSTART_PROFILE_ID: $(SEDSTART_PROFILE_ID)

trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
- group: SedstartVariables   # ← your existing variable group

steps:
- checkout: self

- task: NodeTool@0
  inputs:
    versionSpec: '20.x'
  displayName: 'Install Node.js 20'

- script: |
    echo "Triggering Sedstart test on real API..."

    curl -sX POST https://api.sedstart.io/v1/runs \
      -H "Authorization: Bearer $(SEDSTART_API_KEY)" \
      -H "Content-Type: application/json" \
      -d '{
        "project_id": "$(SEDSTART_PROJECT_ID)",
        "test_id": "$(SEDSTART_TEST_ID)",
        "profile_id": "$(SEDSTART_PROFILE_ID)",
        "browser": "$(SEDSTART_BROWSER)",
        "headless": true,
        "environment": "$(SEDSTART_ENVIRONMENT)",
        "wait_for_completion": true
      }' > sedstart_response.json

    cat sedstart_response.json

    # Safe parsing
    if ! jq . sedstart_response.json > /dev/null 2>&1; then
      echo "##vso[task.logissue type=error]Invalid JSON"
      exit 1
    fi

    STATUS=$(jq -r '.status // "failed"' sedstart_response.json)
    PASSED=$(jq -r '.summary.passed // 0' sedstart_response.json)
    FAILED=$(jq -r '.summary.failed // 0' sedstart_response.json)

    echo "Status: $STATUS"
    echo "Passed: $PASSED | Failed: $FAILED"

    if [ "$STATUS" = "passed" ] || [ "$FAILED" -eq 0 ]; then
      echo "All Sedstart tests PASSED"
    else
      echo "##vso[task.logissue type=error]Sedstart tests FAILED"
      exit 1
    fi
  displayName: 'Run Sedstart Tests – Working Version'



trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

# Your variable group (the one where you stored API key, IDs, etc.)
variables:
- group: SedstartVariables

# These are safe defaults so the pipeline never fails because a variable is empty
- name: SEDSTART_BROWSER
  value: chrome
- name: SEDSTART_HEADLESS
  value: true
- name: SEDSTART_ENVIRONMENT
  value: QA   # or Prod â€“ change if you want

steps:
- checkout: self

# Node + jq are needed for nice JSON parsing
- task: NodeTool@0
  inputs:
    versionSpec: '20.x'
  displayName: 'Install Node.js 20'

# THIS IS THE ONLY STEP THAT RUNS YOUR SEDSTART TESTS
- script: |
    echo "Triggering Sedstart no-code test..."

    curl -s -X POST https://api.sedstart.io/v1/runs \
      -H "Authorization: Bearer $(SEDSTART_API_KEY)" \
      -H "Content-Type: application/json" \
      -d '{
        "project_id": "$(SEDSTART_PROJECT_ID)",
        "test_id": "$(SEDSTART_TEST_ID)",
        "profile_id": "$(SEDSTART_PROFILE_ID)",
        "browser": "$(SEDSTART_BROWSER)",
        "headless": $(SEDSTART_HEADLESS),
        "environment": "$(SEDSTART_ENVIRONMENT)",
        "wait_for_completion": true
      }' > sedstart_response.json

    echo "=== Sedstart raw response ==="
    cat sedstart_response.json
    echo ""

    # Check JSON is valid
    jq . sedstart_response.json > /dev/null || {
      echo "##vso[task.logissue type=error]Sedstart returned invalid JSON"
      exit 1
    }

    # Extract values safely
    STATUS=$(jq -r '.status // "failed"' sedstart_response.json)
    PASSED=$(jq -r '.summary.passed // 0' sedstart_response.json)
    FAILED=$(jq -r '.summary.failed // 0' sedstart_response.json)

    echo "Status  : $STATUS"
    echo "Passed  : $PASSED"
    echo "Failed  : $FAILED"

    # Fail the whole pipeline if anything went wrong
    if [ "$STATUS" != "passed" ] && [ "$FAILED" -gt 0 ]; then
      echo "##vso[task.logissue type=error]Sedstart tests FAILED ($FAILED failed)"
      exit 1
    else
      echo "All Sedstart tests PASSED"
    fi
  displayName: 'Run Sedstart No-Code Tests (Guaranteed Working)'


